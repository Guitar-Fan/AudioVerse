<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upgraded MIDI DAW</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
  <script>eruda.init();</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
            background: #18181b; /* zinc-900 */
            color: #e4e4e7; /* zinc-200 */
        }
        .piano-key {
            stroke: #3f3f46; /* zinc-700 */
            stroke-width: 1;
        }
        .piano-key.white { fill: #f4f4f5; } /* zinc-100 */
        .piano-key.black { fill: #27272a; } /* zinc-800 */
        .piano-key:hover {
            fill: #60a5fa; /* blue-400 */
        }
        .note {
            border-radius: 4px;
            border: 1px solid rgba(0,0,0,0.7);
            position: absolute;
            box-sizing: border-box;
            min-width: 4px;
            /* background-color is set dynamically */
        }
        .piano-label {
            font-size: 10px;
            fill: #a1a1aa; /* zinc-400 */
            text-anchor: end;
            alignment-baseline: middle;
            pointer-events: none;
        }
        .top-bar {
            background: #27272a; /* zinc-800 */
            border-bottom: 1px solid #3f3f46; /* zinc-700 */
            position: relative;
            z-index: 40;
            display: flex;
            align-items: center;
            padding: 0 16px;
            height: 50px;
            flex-shrink: 0;
        }
        #timeline-header {
            background: #27272a; /* zinc-800 */
            border-bottom: 1px solid #3f3f46; /* zinc-700 */
            position: relative;
            z-index: 20;
            height: 30px;
            overflow: hidden;
            flex-shrink: 0;
        }
        #measures-container {
            display: flex;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
        }
        .measure-marker {
            font-size: 12px;
            color: #a1a1aa; /* zinc-400 */
            border-left: 1px solid #52525b; /* zinc-600 */
            box-sizing: border-box;
            display: flex;
            align-items: center;
            padding-left: 4px;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            padding: 0 12px;
            border-left: 1px solid #3f3f46; /* zinc-700 */
            height: 100%;
        }
        .transport-btn, #toolbar button {
            background: transparent;
            border: none;
            color: #e4e4e7;
            border-radius: 6px;
            padding: 8px;
            margin: 0 2px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .transport-btn:hover, #toolbar button:hover {
            background: #3f3f46; /* zinc-700 */
        }
        #toolbar button[data-active='true'] {
             background-color: #3b82f6; /* blue-500 */
             color: white;
        }
        .transport-btn.active {
            color: #3b82f6;
        }
        .transport-btn svg, #toolbar svg {
            width: 20px;
            height: 20px;
            pointer-events: none;
        }
        select, input[type="number"], input[type="range"] {
            background: #3f3f46 !important; /* zinc-700 */
            color: #e4e4e7 !important; /* zinc-200 */
            border-color: #52525b !important; /* zinc-600 */
            border-radius: 4px;
        }
        input[type="number"] {
            padding: 4px 8px;
        }
        #grid-container {
            overflow: auto;
        }
        #playback-cursor {
            position:absolute;
            top:0;
            left:0;
            width:2px;
            height:100%;
            background:#facc15; /* yellow-400 */
            z-index:25;
            pointer-events: none;
            display:none;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div class="top-bar">
        <h1 class="text-xl font-bold text-white mr-4">JS MIDI DAW</h1>
        
        <div class="control-group">
            <label for="upload" class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow transition-colors text-sm">
                Upload MIDI
            </label>
            <input type="file" id="upload" accept=".mid,.midi" class="hidden">
            <button id="export" class="ml-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow transition-colors disabled:bg-gray-500 disabled:cursor-not-allowed text-sm" disabled>Export MIDI</button>
        </div>

        <div class="control-group">
            <button id="rewind-btn" class="transport-btn" title="Rewind to Start">
                <svg fill="currentColor" viewBox="0 0 20 20"><path d="M8.445 14.832A1 1 0 0010 14.032V5.968a1 1 0 00-1.555-.832L4 9.168V6a1 1 0 00-2 0v8a1 1 0 102 0v-3.168l4.445 4zM15.555 14.832A1 1 0 0017 14.032V5.968a1 1 0 00-1.555-.832L11 9.168V6a1 1 0 10-2 0v8a1 1 0 102 0v-3.168l4.555 4z"/></svg>
            </button>
            <button id="play-btn" class="transport-btn" title="Play">
                <svg id="play-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/></svg>
                <svg id="pause-icon" class="hidden" viewBox="0 0 20 20" fill="currentColor"><path d="M5.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75A.75.75 0 007.25 3h-1.5zM12.75 3a.75.75 0 00-.75.75v12.5c0 .414.336.75.75.75h1.5a.75.75 0 00.75-.75V3.75a.75.75 0 00-.75-.75h-1.5z"/></svg>
            </button>
            <button id="stop-btn" class="transport-btn" title="Stop">
                <svg viewBox="0 0 20 20" fill="currentColor"><path d="M5 3.75A1.75 1.75 0 016.75 2h6.5A1.75 1.75 0 0115 3.75v12.5A1.75 1.75 0 0113.25 18h-6.5A1.75 1.75 0 015 16.25V3.75z"/></svg>
            </button>
        </div>
        
        <div class="control-group">
            <label for="signature-select" class="text-sm mr-2">Signature:</label>
            <select id="signature-select" class="text-sm rounded-md p-1">
                <option value="4/4">4/4</option>
                <option value="3/4">3/4</option>
                <option value="6/8">6/8</option>
                <option value="5/4">5/4</option>
            </select>
            <label for="tempo-input" class="text-sm ml-4 mr-2">Tempo:</label>
            <input type="number" id="tempo-input" min="20" max="300" value="120" class="w-16 text-sm">
        </div>

        <div class="control-group">
            <label for="zoom-range" class="text-sm mr-2">Zoom:</label>
            <input type="range" id="zoom-range" min="20" max="500" value="100" class="w-24">
        </div>
    </div>
    
    <div id="toolbar" class="flex items-center h-10 bg-zinc-800/80 backdrop-blur-sm border-b border-zinc-700 px-2 space-x-1 shrink-0">
        <button id="tool-select" title="Select Tool (V)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M14.615 1.585a.75.75 0 0 1 .292.858l-1.076 4.246a.75.75 0 0 1-1.424-.36l1.076-4.246a.75.75 0 0 1 1.132-.5zM16.5 7.5a.75.75 0 0 0-.75-.75h-1.5a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 .75-.75Zm-6.425 1.5a.75.75 0 0 1 .858-.292l4.246 1.076a.75.75 0 0 1 .36 1.424l-4.246-1.076a.75.75 0 0 1-.292-.858Z M10.5 13.5a.75.75 0 0 0-.75.75v1.5a.75.75 0 0 0 1.5 0v-1.5a.75.75 0 0 0-.75-.75ZM9.385 14.615a.75.75 0 0 0-.858.292l-1.076 4.246a.75.75 0 0 0 1.424.36l1.076-4.246a.75.75 0 0 0-.292-.858Z M7.5 16.5a.75.75 0 0 1-.75.75h-1.5a.75.75 0 0 1 0-1.5h1.5a.75.75 0 0 1 .75.75Zm-1.425-6.425a.75.75 0 0 0-.292-.858L1.53 8.14a.75.75 0 0 0-.36 1.424l4.246 1.076a.75.75 0 0 0 .858-.292L6.075 10.075Zm-.292-5.115a.75.75 0 0 1 .858.292l1.076 4.246a.75.75 0 0 1-1.424.36L5.209 5.62a.75.75 0 0 1 .292-.858ZM9.75 4.5a.75.75 0 0 0 .75-.75V2.25a.75.75 0 0 0-1.5 0V3.75a.75.75 0 0 0 .75.75ZM2.25 9.75a.75.75 0 0 1-.75-.75V7.5a.75.75 0 0 1 1.5 0v1.5a.75.75 0 0 1-.75.75Zm12-6.425a.75.75 0 0 0-.292-.858L9.708 1.39a.75.75 0 0 0-.36 1.424l4.246 1.076a.75.75 0 0 0 .858-.292l.000-.001ZM15.75 14.25a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75Zm4.243 2.133a.75.75 0 0 0 .36-1.424l-4.246-1.076a.75.75 0 0 0-.858.292l-1.076 4.246a.75.75 0 0 0 1.424.36l4.246-1.076a.75.75 0 0 0 .292-.858Z" clip-rule="evenodd" /></svg>
        </button>
        <button id="tool-pencil" title="Pencil Tool (B)">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z" /> <path d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z" /></svg>
        </button>
        <button id="tool-cutter" title="Cutter Tool (C)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M3 10.5a2.25 2.25 0 1 0 0 4.5 2.25 2.25 0 0 0 0-4.5ZM5.25 15a2.25 2.25 0 1 0 4.5 0 2.25 2.25 0 0 0-4.5 0Zm8.65-6.69.884-3.536a.75.75 0 0 0-1.42-.354l-.884 3.536a.75.75 0 1 0 1.42.354ZM12 12.75a.75.75 0 0 0-.75-.75h-1.5a.75.75 0 0 0 0 1.5h1.5a.75.75 0 0 0 .75-.75Zm3.31 2.373.53-2.651a.75.75 0 1 0-1.474-.294l-.53 2.651a.75.75 0 1 0 1.474.294ZM19.5 15a2.25 2.25 0 1 0 4.5 0 2.25 2.25 0 0 0-4.5 0Zm-2.25-4.5a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Zm-4.28 1.151a.75.75 0 0 0-1.06 0l-6 6a.75.75 0 0 0 1.06 1.06l6-6a.75.75 0 0 0 0-1.06Z" clip-rule="evenodd" /></svg>
        </button>
    </div>

    <div id="timeline-header">
        <div id="measures-container"></div>
    </div>

    <main id="main-content" class="flex-grow flex overflow-hidden">
        <div id="piano-roll-view" class="flex w-full h-full">
            <div id="piano-keys" class="bg-zinc-800 h-full flex-shrink-0 z-30" style="width: 80px;">
                <svg id="piano-keys-svg" width="80" class="h-full"></svg>
            </div>
            <div id="grid-container" class="flex-grow h-full overflow-auto bg-zinc-900 relative">
                <div id="grid-lines-container" class="absolute top-0 left-0 w-full h-full pointer-events-none z-0"></div>
                <div id="note-container" class="relative z-10 h-full"></div>
                <div id="playback-cursor"></div>
            </div>
        </div>
    </main>

    <script>
        // --- Tone.js Start Context ---
        document.documentElement.addEventListener('mousedown', async () => {
            if (Tone.context.state !== 'running') {
                await Tone.start();
                console.log('Audio context started');
            }
        });

        // --- DOM Elements ---
        const uploadInput = document.getElementById('upload');
        const exportButton = document.getElementById('export');
        
        const pianoKeysSVG = document.getElementById('piano-keys-svg');
        const gridContainer = document.getElementById('grid-container');
        const gridLinesContainer = document.getElementById('grid-lines-container');
        const noteContainer = document.getElementById('note-container');
        const playbackCursor = document.getElementById('playback-cursor');

        const timelineHeader = document.getElementById('timeline-header');
        const measuresContainer = document.getElementById('measures-container');
        const tempoInput = document.getElementById('tempo-input');
        
        const playBtn = document.getElementById('play-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');
        const stopBtn = document.getElementById('stop-btn');
        const rewindBtn = document.getElementById('rewind-btn');
        const zoomRange = document.getElementById('zoom-range');
        const signatureSelect = document.getElementById('signature-select');
        const toolbar = document.getElementById('toolbar');

        // --- State ---
        let midiData = null;
        let zoom = 100; // Represents pixels per second
        let parts = [];
        let synths = [];
        let activeTool = 'select';

        // --- Instruments ---
        let sampler = new Tone.Sampler().toDestination();
        let samplesLoaded = false;
        const trackColors = ['#3b82f6','#22c55e','#ef4444','#eab308','#a855f7','#f97316','#ec4899','#6366f1'];

        // --- Constants ---
        const NOTE_HEIGHT = 16;
        const MIDI_NOTE_RANGE = { min: 21, max: 108 };

        // --- Initialization ---
        window.onload = () => {
            setupPianoKeys();
            setupToolbar();
            draw();
            Tone.Transport.bpm.value = parseInt(tempoInput.value, 10);
            const sig = signatureSelect.value.split('/').map(n => parseInt(n));
            Tone.Transport.timeSignature = sig;
        };

        // --- Event Listeners ---
        uploadInput.addEventListener('change', handleFileUpload);
        exportButton.addEventListener('click', handleExport);
        tempoInput.addEventListener('change', (e) => {
            const tempo = parseInt(e.target.value, 10) || 120;
            Tone.Transport.bpm.value = tempo;
            draw();
        });
        signatureSelect.addEventListener('change', (e) => {
            const sig = e.target.value.split('/').map(n => parseInt(n));
            Tone.Transport.timeSignature = sig;
            draw();
        });
        zoomRange.addEventListener('input', (e) => {
            zoom = parseInt(e.target.value, 10);
            draw();
        });
        gridContainer.addEventListener('scroll', () => {
            pianoKeysSVG.style.marginTop = `-${gridContainer.scrollTop}px`;
            timelineHeader.scrollLeft = gridContainer.scrollLeft;
        });

        playBtn.addEventListener('click', handlePlayPause);
        stopBtn.addEventListener('click', handleStop);
        rewindBtn.addEventListener('click', handleRewind);

        // --- File & MIDI Handling ---
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            try {
                const arrayBuffer = await file.arrayBuffer();
                midiData = new Midi(arrayBuffer);
                exportButton.disabled = false;
                
                if (midiData.header.tempos.length > 0) {
                    const tempo = Math.round(midiData.header.tempos[0].bpm);
                    tempoInput.value = tempo;
                    Tone.Transport.bpm.value = tempo;
                }
                if (midiData.header.timeSignatures.length > 0) {
                    const sig = midiData.header.timeSignatures[0].timeSignature;
                    const sigString = `${sig[0]}/${sig[1]}`;
                    if ([...signatureSelect.options].some(o => o.value === sigString)) {
                        signatureSelect.value = sigString;
                        Tone.Transport.timeSignature = sig;
                    }
                }
                draw();
            } catch (error) {
                console.error("Error parsing MIDI file:", error);
                alert("Could not parse the MIDI file.");
            }
        }

        function handleExport() {
            if (!midiData) return;
            try {
                const midiArray = midiData.toArray();
                const blob = new Blob([midiArray], { type: "audio/midi" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `${midiData.name || 'exported_midi'}.mid`;
                a.click();
                URL.revokeObjectURL(a.href);
            } catch (error) {
                console.error("Error exporting MIDI file:", error);
            }
        }
        
        // --- Drawing and UI ---
        function setupToolbar() {
            const tools = ['select', 'pencil', 'cutter'];
            tools.forEach(tool => {
                const btn = document.getElementById(`tool-${tool}`);
                if(btn) btn.addEventListener('click', () => setActiveTool(tool));
            });
            setActiveTool('select'); // Set default tool
        }

        function setActiveTool(toolName) {
            activeTool = toolName;
            ['select', 'pencil', 'cutter'].forEach(tool => {
                const btn = document.getElementById(`tool-${tool}`);
                if(btn) btn.dataset.active = (tool === toolName);
            });
            gridContainer.style.cursor = toolName === 'pencil' ? 'crosshair' : 'default';
        }

        function draw() {
            if (Tone.Transport.state === 'started') handleStop();
            drawPianoRoll();
            drawTimeline();
            drawGrid();
        }

        function setupPianoKeys() {
            const keys = [];
            for (let midi = MIDI_NOTE_RANGE.max; midi >= MIDI_NOTE_RANGE.min; midi--) {
                const isBlack = [1, 3, 6, 8, 10].includes(midi % 12);
                keys.push({ midi, black: isBlack, name: Tone.Midi(midi).toNote() });
            }

            pianoKeysSVG.innerHTML = '';
            const svgNS = "http://www.w3.org/2000/svg";
            const keyWidth = 80;
            const blackKeyWidth = 50;
            const totalHeight = keys.length * NOTE_HEIGHT;
            
            pianoKeysSVG.setAttribute('viewBox', `0 0 ${keyWidth} ${totalHeight}`);
            pianoKeysSVG.style.height = `${totalHeight}px`;
            noteContainer.style.height = `${totalHeight}px`;
            gridLinesContainer.style.height = `${totalHeight}px`;

            keys.forEach((key, idx) => {
                const y = idx * NOTE_HEIGHT;
                const rect = document.createElementNS(svgNS, 'rect');
                rect.setAttribute('x', 0);
                rect.setAttribute('y', y);
                rect.setAttribute('width', key.black ? blackKeyWidth : keyWidth);
                rect.setAttribute('height', NOTE_HEIGHT);
                rect.setAttribute('class', key.black ? 'piano-key black' : 'piano-key white');
                rect.dataset.midi = key.midi;
                pianoKeysSVG.appendChild(rect);

                if (!key.black) {
                    const text = document.createElementNS(svgNS, 'text');
                    text.setAttribute('x', keyWidth - 5);
                    text.setAttribute('y', y + NOTE_HEIGHT / 2);
                    text.setAttribute('class', 'piano-label');
                    text.textContent = key.name;
                    pianoKeysSVG.appendChild(text);
                }
            });
        }
        
        function drawGrid() {
            gridLinesContainer.innerHTML = '';
            const totalDuration = midiData ? midiData.duration : 120;
            const containerWidth = totalDuration * zoom;

            const numKeys = MIDI_NOTE_RANGE.max - MIDI_NOTE_RANGE.min + 1;
            for (let i = 0; i <= numKeys; i++) {
                const line = document.createElement('div');
                const isBlackKey = [1, 3, 6, 8, 10].includes((MIDI_NOTE_RANGE.max - i) % 12);
                line.className = `absolute w-full h-px ${isBlackKey ? 'bg-zinc-700/75' : 'bg-zinc-800'}`;
                line.style.top = `${i * NOTE_HEIGHT -1}px`;
                line.style.width = `${containerWidth}px`;
                gridLinesContainer.appendChild(line);
            }
            
            const beatsPerMeasure = Tone.Transport.timeSignature[0];
            const subdivision = Tone.Transport.timeSignature[1];
            const secondsPerBeat = 60 / Tone.Transport.bpm.value;
            const measureCount = Math.ceil(totalDuration / (secondsPerBeat * beatsPerMeasure));

            for (let m = 0; m < measureCount; m++) {
                for (let b = 0; b < beatsPerMeasure; b++) {
                    const time = (m * beatsPerMeasure + b) * secondsPerBeat;
                    const x = time * zoom;
                    const line = document.createElement('div');
                    line.className = `absolute h-full w-px ${b === 0 ? 'bg-zinc-600' : 'bg-zinc-700'}`;
                    line.style.left = `${x}px`;
                    gridLinesContainer.appendChild(line);
                }
            }
        }

        function drawPianoRoll() {
            noteContainer.innerHTML = '';
            if (!midiData) {
                 noteContainer.style.width = '100%';
                 return;
            }

            const totalDuration = midiData.duration;
            const containerWidth = Math.max(totalDuration * zoom, gridContainer.clientWidth);
            noteContainer.style.width = `${containerWidth}px`;

            const midiKeys = Array.from({ length: MIDI_NOTE_RANGE.max - MIDI_NOTE_RANGE.min + 1 }, (_, i) => MIDI_NOTE_RANGE.max - i);

            midiData.tracks.forEach((track, trackIndex) => {
                const color = trackColors[trackIndex % trackColors.length];
                track.notes.forEach(note => {
                    const keyIdx = midiKeys.indexOf(note.midi);
                    if (keyIdx === -1) return;

                    const noteDiv = document.createElement('div');
                    noteDiv.classList.add('note');
                    const y = keyIdx * NOTE_HEIGHT;
                    const x = note.time * zoom;
                    const width = note.duration * zoom;
                    
                    noteDiv.style.top = `${y}px`;
                    noteDiv.style.left = `${x}px`;
                    noteDiv.style.width = `${width}px`;
                    noteDiv.style.height = `${NOTE_HEIGHT - 2}px`;
                    noteDiv.style.backgroundColor = color;
                    noteDiv.style.opacity = note.velocity * 0.7 + 0.3;
                    noteDiv.title = `Track ${trackIndex + 1}\nNote: ${note.name}\nTime: ${note.time.toFixed(2)}s\nVel: ${Math.round(note.velocity * 100)}%`;
                    noteContainer.appendChild(noteDiv);
                });
            });
        }

        function drawTimeline() {
            measuresContainer.innerHTML = '';
            const totalDuration = midiData ? midiData.duration : 120;
            const beatsPerMeasure = Tone.Transport.timeSignature[0];
            const secondsPerBeat = 60 / Tone.Transport.bpm.value;
            const secondsPerMeasure = secondsPerBeat * beatsPerMeasure;
            const measureWidth = secondsPerMeasure * zoom;
            const measureCount = Math.ceil(totalDuration / secondsPerMeasure);

            for (let i = 0; i < measureCount; i++) {
                const marker = document.createElement('div');
                marker.className = 'measure-marker';
                marker.style.width = `${measureWidth}px`;
                marker.textContent = `${i + 1}`;
                measuresContainer.appendChild(marker);
            }
        }

        // --- Sampler Logic ---
        pianoKeysSVG.addEventListener('click', async (e) => {
            if (!e.target.dataset.midi) return;
            const midi = parseInt(e.target.dataset.midi);
            const noteName = Tone.Midi(midi).toNote();
            alert(`Click a key to play. To load a sample for ${noteName}, create an input element.`);
            // Existing sampler loading logic preserved
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'audio/*';
            fileInput.onchange = async (ev) => {
                const file = ev.target.files[0];
                if (!file) return;
                const url = URL.createObjectURL(file);
                sampler.add(noteName, url, () => {
                    console.log(`Sample for ${noteName} loaded.`);
                    samplesLoaded = true;
                    alert(`Sample for ${noteName} loaded successfully!`);
                });
            };
            fileInput.click();
        });

        // --- Playback Controls ---
        function handlePlayPause() {
            if (Tone.Transport.state === 'started') {
                Tone.Transport.pause();
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
            } else {
                if (!midiData) return;
                prepareParts();
                Tone.Transport.start();
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                showPlaybackCursor();
            }
        }

        function handleStop() {
            Tone.Transport.stop();
            Tone.Transport.position = 0;
            parts.forEach(p => { p.stop(0); p.dispose(); });
            parts = [];
            synths.forEach(s => s.dispose());
            synths = [];
            playIcon.classList.remove('hidden');
            pauseIcon.classList.add('hidden');
            hidePlaybackCursor();
        }

        function handleRewind() {
            Tone.Transport.position = 0;
            updatePlaybackCursor();
        }

        function prepareParts() {
            if (parts.length > 0) handleStop();
            if (!midiData) return;

            midiData.tracks.forEach(track => {
                if (track.notes.length === 0) return;
                const instrument = samplesLoaded ? sampler : new Tone.PolySynth(Tone.Synth).toDestination();
                if (!samplesLoaded) synths.push(instrument);

                const part = new Tone.Part((time, note) => {
                    instrument.triggerAttackRelease(note.name, note.duration, time, note.velocity);
                }, track.notes).start(0);
                parts.push(part);
            });
        }

        // --- Playback Cursor ---
        let cursorAnimationFrame = null;

        function showPlaybackCursor() {
            playbackCursor.style.display = 'block';
            updatePlaybackCursor();
        }

        function hidePlaybackCursor() {
            playbackCursor.style.display = 'none';
            if (cursorAnimationFrame) {
                cancelAnimationFrame(cursorAnimationFrame);
                cursorAnimationFrame = null;
            }
        }

        function updatePlaybackCursor() {
            if (Tone.Transport.state !== 'started') {
                const x = Tone.Transport.seconds * zoom;
                playbackCursor.style.transform = `translateX(${x}px)`;
                if (Tone.Transport.state === "stopped") hidePlaybackCursor();
                return;
            }
            const x = Tone.Transport.seconds * zoom;
            playbackCursor.style.transform = `translateX(${x}px)`;

            const gridRect = gridContainer.getBoundingClientRect();
            if (x > gridContainer.scrollLeft + gridRect.width - 50) {
                gridContainer.scrollLeft = x - gridRect.width + 50;
            } else if (x < gridContainer.scrollLeft + 50) {
                gridContainer.scrollLeft = Math.max(0, x - 50);
            }
            
            cursorAnimationFrame = requestAnimationFrame(updatePlaybackCursor);
        }

    </script>
</body>
</html>