<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C++ WASM Example</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #cc7a00;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #995c00;
        }
        input, textarea {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        textarea {
            width: 90%;
            height: 60px;
        }
        #output {
            background: #f8f8f8;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            min-height: 120px;
            font-family: monospace;
        }
        canvas {
            border: 1px solid #ddd;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>⚡ C++ WebAssembly Example</h1>
    
    <div class="container">
        <h2>Basic Functions</h2>
        <div>
            <input type="number" id="addA" placeholder="First number" value="15">
            <input type="number" id="addB" placeholder="Second number" value="25">
            <button onclick="testAddNumbers()">Add (C++)</button>
        </div>
        <div>
            <input type="number" id="mulA" placeholder="First number" step="0.1" value="3.14">
            <input type="number" id="mulB" placeholder="Second number" step="0.1" value="2.5">
            <button onclick="testMultiply()">Multiply (C++)</button>
        </div>
    </div>
    
    <div class="container">
        <h2>Math Calculator Class</h2>
        <div>
            <button onclick="createCalculator()">Create Calculator</button>
            <input type="number" id="calcInput" placeholder="Value" step="0.1" value="5">
            <button onclick="calcAdd()">Add</button>
            <button onclick="calcMultiply()">Multiply</button>
            <button onclick="calcPower()">Power</button>
            <button onclick="calcReset()">Reset</button>
            <button onclick="calcGetValue()">Get Value</button>
        </div>
    </div>
    
    <div class="container">
        <h2>Array Processing</h2>
        <div>
            <textarea id="arrayInput" placeholder="Enter numbers separated by commas (e.g., 1.5, 2.3, 3.7, 4.2)">[1.5, 2.3, 3.7, 4.2, 5.1]</textarea>
            <br>
            <button onclick="testArrayProcessing()">Process Array (x2 + 1)</button>
        </div>
    </div>
    
    <div class="container">
        <h2>Audio Processing Simulation</h2>
        <div>
            <button onclick="testAudioProcessing()">Test Audio Buffer Processing</button>
            <input type="range" id="gainSlider" min="0" max="2" step="0.1" value="1.2">
            <span id="gainValue">1.2</span>
            <br>
            <canvas id="audioCanvas" width="400" height="200"></canvas>
        </div>
    </div>
    
    <div class="container">
        <h2>DSP Filter</h2>
        <div>
            <button onclick="createFilter()">Create Filter</button>
            <input type="range" id="cutoffSlider" min="0.01" max="0.99" step="0.01" value="0.3">
            <span id="cutoffValue">0.3</span>
            <button onclick="testFilter()">Test Filter Response</button>
            <br>
            <canvas id="filterCanvas" width="400" height="200"></canvas>
        </div>
    </div>
    
    <div class="container">
        <h2>Output</h2>
        <div id="output">Loading C++ WASM module...</div>
    </div>

    <script>
        let Module;
        let calculator;
        let filter;
        
        // Initialize sliders
        document.getElementById('gainSlider').addEventListener('input', function(e) {
            document.getElementById('gainValue').textContent = e.target.value;
        });
        
        document.getElementById('cutoffSlider').addEventListener('input', function(e) {
            document.getElementById('cutoffValue').textContent = e.target.value;
        });
        
        function log(message) {
            const output = document.getElementById('output');
            output.innerHTML += message + '\\n';
            output.scrollTop = output.scrollHeight;
        }
        
        function testAddNumbers() {
            const a = parseInt(document.getElementById('addA').value);
            const b = parseInt(document.getElementById('addB').value);
            const result = Module.add_numbers(a, b);
            log(`C++ add_numbers(${a}, ${b}) = ${result}`);
        }
        
        function testMultiply() {
            const a = parseFloat(document.getElementById('mulA').value);
            const b = parseFloat(document.getElementById('mulB').value);
            const result = Module.multiply_doubles(a, b);
            log(`C++ multiply_doubles(${a}, ${b}) = ${result}`);
        }
        
        function createCalculator() {
            calculator = new Module.MathCalculator();
            log('✅ Created new MathCalculator instance');
        }
        
        function calcAdd() {
            if (!calculator) { log('❌ Create calculator first!'); return; }
            const value = parseFloat(document.getElementById('calcInput').value);
            calculator.add(value);
            log(`Added ${value} to calculator`);
        }
        
        function calcMultiply() {
            if (!calculator) { log('❌ Create calculator first!'); return; }
            const value = parseFloat(document.getElementById('calcInput').value);
            calculator.multiply(value);
            log(`Multiplied calculator by ${value}`);
        }
        
        function calcPower() {
            if (!calculator) { log('❌ Create calculator first!'); return; }
            const value = parseFloat(document.getElementById('calcInput').value);
            calculator.power(value);
            log(`Raised calculator to power ${value}`);
        }
        
        function calcReset() {
            if (!calculator) { log('❌ Create calculator first!'); return; }
            calculator.reset();
            log('Calculator reset to 0');
        }
        
        function calcGetValue() {
            if (!calculator) { log('❌ Create calculator first!'); return; }
            const value = calculator.getResult();
            log(`Calculator current value: ${value}`);
        }
        
        function testArrayProcessing() {
            if (!calculator) { log('❌ Create calculator first!'); return; }
            try {
                const input = JSON.parse(document.getElementById('arrayInput').value);
                const inputVector = new Module.VectorDouble();
                for (let val of input) {
                    inputVector.push_back(val);
                }
                
                const result = calculator.processArray(inputVector);
                const output = [];
                for (let i = 0; i < result.size(); i++) {
                    output.push(result.get(i));
                }
                
                log(`Input: [${input.join(', ')}]`);
                log(`Output: [${output.join(', ')}]`);
                
                inputVector.delete();
                result.delete();
            } catch (e) {
                log(`❌ Error: ${e.message}`);
            }
        }
        
        function testAudioProcessing() {
            const gain = parseFloat(document.getElementById('gainSlider').value);
            
            // Generate test audio data (sine wave)
            const sampleRate = 44100;
            const frequency = 440; // A note
            const duration = 0.1; // 100ms
            const samples = Math.floor(sampleRate * duration);
            
            const inputVector = new Module.VectorFloat();
            const inputArray = [];
            
            for (let i = 0; i < samples; i++) {
                const sample = 0.5 * Math.sin(2 * Math.PI * frequency * i / sampleRate);
                inputVector.push_back(sample);
                inputArray.push(sample);
            }
            
            const result = Module.processAudioBuffer(inputVector, gain);
            const outputArray = [];
            
            for (let i = 0; i < result.size(); i++) {
                outputArray.push(result.get(i));
            }
            
            log(`Processed ${samples} audio samples with gain ${gain}`);
            log(`Peak input: ${Math.max(...inputArray).toFixed(3)}, Peak output: ${Math.max(...outputArray).toFixed(3)}`);
            
            // Visualize on canvas
            drawAudioWaveform(inputArray, outputArray);
            
            inputVector.delete();
            result.delete();
        }
        
        function drawAudioWaveform(input, output) {
            const canvas = document.getElementById('audioCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#007acc';
            ctx.lineWidth = 1;
            
            // Draw input waveform
            ctx.beginPath();
            for (let i = 0; i < Math.min(input.length, canvas.width); i++) {
                const x = i * canvas.width / Math.min(input.length, canvas.width);
                const y = canvas.height / 4 + input[i] * canvas.height / 8;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // Draw output waveform
            ctx.strokeStyle = '#cc7a00';
            ctx.beginPath();
            for (let i = 0; i < Math.min(output.length, canvas.width); i++) {
                const x = i * canvas.width / Math.min(output.length, canvas.width);
                const y = 3 * canvas.height / 4 + output[i] * canvas.height / 8;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // Labels
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText('Input (blue)', 10, 20);
            ctx.fillText('Output (orange)', 10, canvas.height - 10);
        }
        
        function createFilter() {
            const cutoff = parseFloat(document.getElementById('cutoffSlider').value);
            filter = new Module.SimpleFilter(cutoff);
            log(`✅ Created SimpleFilter with cutoff ${cutoff}`);
        }
        
        function testFilter() {
            if (!filter) { log('❌ Create filter first!'); return; }
            
            const cutoff = parseFloat(document.getElementById('cutoffSlider').value);
            filter.setCutoff(cutoff);
            filter.reset();
            
            // Test filter with impulse response
            const impulseResponse = [];
            const input = 1.0; // Impulse
            
            for (let i = 0; i < 100; i++) {
                const sample = i === 0 ? input : 0.0;
                const output = filter.process(sample);
                impulseResponse.push(output);
            }
            
            log(`Filter impulse response calculated (cutoff: ${cutoff})`);
            drawFilterResponse(impulseResponse);
        }
        
        function drawFilterResponse(response) {
            const canvas = document.getElementById('filterCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#cc7a00';
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            for (let i = 0; i < response.length; i++) {
                const x = i * canvas.width / response.length;
                const y = canvas.height - (response[i] + 1) * canvas.height / 4;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.stroke();
            
            // Grid lines
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
            
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText('Filter Impulse Response', 10, 20);
        }
    </script>
    
    <script async src="math_processor.js" onload="log('✅ C++ WASM module loaded successfully!')"></script>
</body>
</html>
