<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Integration Test</title>
</head>
<body>
    <h1>REAPER WASM Integration Test</h1>
    <div id="status">Loading...</div>
    <div id="log"></div>
    
    <button onclick="testTransport()" id="testBtn" disabled>Test Transport Controls</button>
    
    <script src="js/reaper-web.js"></script>
    <script>
        let wasmModule = null;
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');
        const testBtn = document.getElementById('testBtn');
        
        function log(message) {
            const div = document.createElement('div');
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logDiv.appendChild(div);
            console.log(message);
        }
        
        async function initWASM() {
            try {
                statusDiv.textContent = 'Loading WASM module...';
                log('Attempting to load WASM module...');
                
                if (typeof ReaperWebModule !== 'undefined') {
                    log('ReaperWebModule found, initializing...');
                    wasmModule = await ReaperWebModule();
                    log('WASM module loaded successfully!');
                    
                    // Check if API is available
                    if (wasmModule.ReaperWebAPI) {
                        log('ReaperWebAPI found!');
                        
                        // Test engine creation
                        const result = wasmModule.ReaperWebAPI.createEngine();
                        log('Engine create result: ' + result);
                        
                        if (result) {
                            // Initialize engine
                            wasmModule.ReaperWebAPI.initializeEngine(44100, 512, 2);
                            log('Engine initialized with 44100 Hz, 512 buffer, 2 channels');
                            
                            statusDiv.textContent = 'WASM module loaded and initialized!';
                            testBtn.disabled = false;
                        }
                    } else {
                        log('ReaperWebAPI not found, checking raw exports...');
                        
                        // Check raw functions
                        if (typeof wasmModule._reaper_engine_create === 'function') {
                            const result = wasmModule._reaper_engine_create();
                            log('Engine create result: ' + result);
                            
                            if (result) {
                                wasmModule._reaper_engine_initialize(44100, 512, 2);
                                log('Engine initialized with raw functions');
                                statusDiv.textContent = 'WASM module loaded with raw functions!';
                                testBtn.disabled = false;
                            }
                        } else {
                            log('ERROR: No engine create function found');
                        }
                    }
                } else {
                    log('ERROR: ReaperWebModule not found');
                    statusDiv.textContent = 'WASM module not found!';
                }
            } catch (error) {
                log('ERROR loading WASM: ' + error.message);
                log('Stack trace: ' + error.stack);
                statusDiv.textContent = 'Error loading WASM module';
            }
        }
        
        function testTransport() {
            if (!wasmModule) {
                log('ERROR: WASM module not loaded');
                return;
            }
            
            log('Testing transport controls...');
            
            const api = wasmModule.ReaperWebAPI || wasmModule;
            
            // Test play
            try {
                if (api.play) {
                    api.play();
                    log('✓ Play function called via API');
                } else if (api._reaper_engine_play) {
                    api._reaper_engine_play();
                    log('✓ Play function called via raw export');
                } else {
                    log('✗ Play function not found');
                }
            } catch (e) {
                log('✗ Play function error: ' + e.message);
            }
            
            // Test pause
            setTimeout(() => {
                try {
                    if (api.pause) {
                        api.pause();
                        log('✓ Pause function called via API');
                    } else if (api._reaper_engine_pause) {
                        api._reaper_engine_pause();
                        log('✓ Pause function called via raw export');
                    } else {
                        log('✗ Pause function not found');
                    }
                } catch (e) {
                    log('✗ Pause function error: ' + e.message);
                }
            }, 1000);
            
            // Test stop
            setTimeout(() => {
                try {
                    if (api.stop) {
                        api.stop();
                        log('✓ Stop function called via API');
                    } else if (api._reaper_engine_stop) {
                        api._reaper_engine_stop();
                        log('✓ Stop function called via raw export');
                    } else {
                        log('✗ Stop function not found');
                    }
                } catch (e) {
                    log('✗ Stop function error: ' + e.message);
                }
            }, 2000);
        }
        
        // Initialize on page load
        window.addEventListener('load', initWASM);
    </script>
</body>
</html>