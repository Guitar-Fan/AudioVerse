<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioVerse C++ DAW - Fixed Version Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #4fc3f7;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .status-panel {
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid #4fc3f7;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section {
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid #4caf50;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            align-items: center;
        }
        
        button {
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 195, 247, 0.4);
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .log {
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        
        .success { color: #4caf50; }
        .error { color: #f44336; }
        .info { color: #2196f3; }
        .warning { color: #ff9800; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ AudioVerse C++ DAW - Fixed Version Test</h1>
        
        <div class="status-panel">
            <h3>Engine Status</h3>
            <div id="engineStatus">Initializing...</div>
            <div id="engineDetails">Loading C++ WASM Engine...</div>
        </div>
        
        <div class="test-section">
            <h3>Engine Tests</h3>
            <div class="control-group">
                <button id="testInitBtn">Test Engine Initialization</button>
                <button id="testBasicBtn" disabled>Test Basic Functions</button>
                <button id="testAudioBtn" disabled>Test Audio Processing</button>
            </div>
        </div>
        
        <div class="test-section">
            <h3>DAW Controls</h3>
            <div class="control-group">
                <button id="playBtn" disabled>‚ñ∂ Play</button>
                <button id="pauseBtn" disabled>‚è∏ Pause</button>
                <button id="stopBtn" disabled>‚èπ Stop</button>
                <button id="addTrackBtn" disabled>+ Add Track</button>
            </div>
            <div class="control-group">
                <label>Tempo: <input type="range" id="tempoSlider" min="60" max="200" value="120" disabled></label>
                <span id="tempoValue">120 BPM</span>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Console Log</h3>
            <div id="consoleLog" class="log"></div>
        </div>
    </div>

    <!-- Load the C++ WASM module -->
    <script src="advanced_cpp_daw.js"></script>
    
    <script>
        // Test interface for the fixed C++ DAW
        class FixedDAWTester {
            constructor() {
                this.cppEngine = null;
                this.isInitialized = false;
                this.initializeElements();
                this.bindEvents();
                this.log('DAW Tester initialized', 'info');
                this.initializeEngine();
            }
            
            initializeElements() {
                this.engineStatus = document.getElementById('engineStatus');
                this.engineDetails = document.getElementById('engineDetails');
                this.consoleLog = document.getElementById('consoleLog');
                
                this.testInitBtn = document.getElementById('testInitBtn');
                this.testBasicBtn = document.getElementById('testBasicBtn');
                this.testAudioBtn = document.getElementById('testAudioBtn');
                
                this.playBtn = document.getElementById('playBtn');
                this.pauseBtn = document.getElementById('pauseBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.addTrackBtn = document.getElementById('addTrackBtn');
                
                this.tempoSlider = document.getElementById('tempoSlider');
                this.tempoValue = document.getElementById('tempoValue');
            }
            
            bindEvents() {
                this.testInitBtn.addEventListener('click', () => this.testInitialization());
                this.testBasicBtn.addEventListener('click', () => this.testBasicFunctions());
                this.testAudioBtn.addEventListener('click', () => this.testAudioProcessing());
                
                this.playBtn.addEventListener('click', () => this.play());
                this.pauseBtn.addEventListener('click', () => this.pause());
                this.stopBtn.addEventListener('click', () => this.stop());
                this.addTrackBtn.addEventListener('click', () => this.addTrack());
                
                this.tempoSlider.addEventListener('input', (e) => {
                    const tempo = parseInt(e.target.value);
                    this.tempoValue.textContent = tempo + ' BPM';
                    if (this.cppEngine && this.isInitialized) {
                        this.cppEngine._setTempo(tempo);
                    }
                });
            }
            
            async initializeEngine() {
                try {
                    this.log('Loading C++ WASM module...', 'info');
                    this.updateStatus('Loading...', 'Loading C++ WASM Engine...');
                    
                    if (typeof CPPDAWModule === 'undefined') {
                        throw new Error('CPPDAWModule not found');
                    }
                    
                    this.cppEngine = await CPPDAWModule();
                    this.log('WASM module loaded successfully', 'success');
                    
                    this.updateStatus('Loaded', 'C++ WASM Engine Ready');
                    this.testInitBtn.disabled = false;
                    
                } catch (error) {
                    this.log('Error loading WASM module: ' + error.message, 'error');
                    this.updateStatus('Failed', 'Engine Load Failed: ' + error.message);
                }
            }
            
            testInitialization() {
                try {
                    this.log('Testing engine initialization...', 'info');
                    
                    if (!this.cppEngine) {
                        throw new Error('WASM module not loaded');
                    }
                    
                    // Test if functions are available
                    const requiredFunctions = ['_initializeDAW', '_getIsInitialized', '_addTrack', '_play', '_stop'];
                    for (const func of requiredFunctions) {
                        if (typeof this.cppEngine[func] !== 'function') {
                            throw new Error(`Required function ${func} not found`);
                        }
                    }
                    
                    // Initialize the DAW
                    this.cppEngine._initializeDAW();
                    this.log('DAW initialization called', 'info');
                    
                    // Check initialization status
                    const isInitialized = this.cppEngine._getIsInitialized();
                    if (isInitialized) {
                        this.isInitialized = true;
                        this.log('‚úÖ Engine initialized successfully!', 'success');
                        this.updateStatus('Initialized', 'C++ DAW Engine Ready');
                        this.enableControls();
                    } else {
                        throw new Error('Engine initialization failed');
                    }
                    
                } catch (error) {
                    this.log('‚ùå Initialization failed: ' + error.message, 'error');
                    this.updateStatus('Failed', 'Initialization Error');
                }
            }
            
            testBasicFunctions() {
                try {
                    this.log('Testing basic DAW functions...', 'info');
                    
                    // Test tempo
                    this.cppEngine._setTempo(140);
                    const tempo = this.cppEngine._getTempo();
                    this.log(`Tempo set to 140, got back: ${tempo}`, tempo === 140 ? 'success' : 'warning');
                    
                    // Test master volume
                    this.cppEngine._setMasterVolume(0.8);
                    
                    // Test getting current state
                    const isPlaying = this.cppEngine._getIsPlaying();
                    const trackCount = this.cppEngine._getTrackCount();
                    
                    this.log(`Is playing: ${isPlaying}, Track count: ${trackCount}`, 'info');
                    this.log('‚úÖ Basic functions test passed!', 'success');
                    
                    this.testAudioBtn.disabled = false;
                    
                } catch (error) {
                    this.log('‚ùå Basic functions test failed: ' + error.message, 'error');
                }
            }
            
            testAudioProcessing() {
                try {
                    this.log('Testing audio processing features...', 'info');
                    
                    // Add a track
                    const trackId = this.cppEngine._addTrack();
                    this.log(`Created track with ID: ${trackId}`, 'success');
                    
                    // Set track properties
                    this.cppEngine._setTrackVolume(trackId, 0.7);
                    this.cppEngine._setTrackPan(trackId, 0.0);
                    
                    // Add effects
                    this.cppEngine._addReverbToTrack(trackId, 0.5, 0.3, 0.2);
                    this.cppEngine._addDelayToTrack(trackId, 0.25, 0.3, 0.2);
                    this.cppEngine._setTrackFilterCutoff(trackId, 1000);
                    
                    // Generate some audio
                    this.cppEngine._generateSynthOnTrack(trackId, 440, 1024);
                    
                    this.log('‚úÖ Audio processing test passed!', 'success');
                    this.log('üéµ Track created with reverb, delay, and filter effects', 'success');
                    
                } catch (error) {
                    this.log('‚ùå Audio processing test failed: ' + error.message, 'error');
                }
            }
            
            play() {
                if (this.cppEngine && this.isInitialized) {
                    this.cppEngine._play();
                    this.log('‚ñ∂ Play started', 'info');
                }
            }
            
            pause() {
                if (this.cppEngine && this.isInitialized) {
                    this.cppEngine._pause();
                    this.log('‚è∏ Paused', 'info');
                }
            }
            
            stop() {
                if (this.cppEngine && this.isInitialized) {
                    this.cppEngine._stop();
                    this.log('‚èπ Stopped', 'info');
                }
            }
            
            addTrack() {
                if (this.cppEngine && this.isInitialized) {
                    const trackId = this.cppEngine._addTrack();
                    this.log(`+ Track ${trackId} added`, 'success');
                }
            }
            
            enableControls() {
                this.testBasicBtn.disabled = false;
                this.playBtn.disabled = false;
                this.pauseBtn.disabled = false;
                this.stopBtn.disabled = false;
                this.addTrackBtn.disabled = false;
                this.tempoSlider.disabled = false;
            }
            
            updateStatus(status, details) {
                this.engineStatus.textContent = status;
                this.engineDetails.textContent = details;
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = type;
                logEntry.textContent = `[${timestamp}] ${message}`;
                this.consoleLog.appendChild(logEntry);
                this.consoleLog.scrollTop = this.consoleLog.scrollHeight;
                
                // Also log to browser console
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }
        
        // Initialize the tester when the page loads
        window.addEventListener('load', () => {
            new FixedDAWTester();
        });
    </script>
</body>
</html>